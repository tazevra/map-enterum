// main.js — логика главной карты
// Используем изображение карты мира как подложку
const imageUrl = 'IMG/world.webp'; // Путь к изображению карты мира
const imageBounds = [[0,0], [4096,4096]]; // Карта мира: 4096x4096
// Используем CRS.Simple для точного отображения изображения
const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2, // Максимальное приближение в 2 раза
  maxBounds: imageBounds, // Ограничение перемещения ровно по картинке
  maxBoundsViscosity: 1.0 // Жёсткое ограничение
});
L.imageOverlay(imageUrl, imageBounds).addTo(map);
// Масштабирование по ширине 4096px
const mapWidth = 4096;
const windowWidth = window.innerWidth;
const zoomToFitWidth = Math.log2(windowWidth / mapWidth);
map.setView([imageBounds[1][0] / 2, mapWidth / 2], zoomToFitWidth);

// Новые регионы с координатами под изображение
const regions = [
  {
    name: 'ЙОШИХАРА', // Название города (будет крупно в подсказке)
    location: 'Арамидис', // Название региона (будет выделено цветом)
    locationColor: '#8EEB00', // Цвет для названия региона Арамидис (#8EEB00)
    desc: 'Йошихара, или как его называют местные люди - “Город розовых слёз”. Город торговли, фестивалей и магии.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/joshixara.124/',
    polygon: [
      [3076, 1184], [3063, 1167], [3036, 1154], [3018, 1162], [3013, 1193], [2999, 1210], [2987, 1235], [2976, 1260], [2956, 1258], 
      [2941, 1278], [2934, 1301], [2932, 1332], [2943, 1351], [2969, 1358], [2986, 1381], [3005, 1407], [3029, 1425], [3052, 1430], 
      [3056, 1407], [3069, 1405], [3082, 1396], [3098, 1381], [3113, 1364], [3130, 1369], [3153, 1382], [3178, 1381], [3197, 1362], 
      [3203, 1339], [3184, 1322], [3168, 1315], [3160, 1304], [3163, 1282], [3141, 1280], [3132, 1269], [3119, 1265], [3116, 1252], 
      [3105, 1242], [3087, 1234], [3070, 1226], [3068, 1210], [3071, 1197], [3078, 1185]
    ]
  },
  {
    name: 'РИКУТЕН', // Название города (будет крупно в подсказке)
    location: 'Арамидис', // Название региона (будет выделено цветом)
    locationColor: '#8EEB00', // Цвет для названия региона Арамидис (#8EEB00)
    desc: 'Город бандитов и контрабандистов.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/rikuten.138/',
    polygon: [
      [2741, 1632], [2749, 1645], [2762, 1633], [2764, 1640], [2753, 1668], [2752, 1700], [2756, 1730], [2770, 1756], [2784, 1774], 
      [2804, 1767], [2824, 1755], [2840, 1747], [2850, 1733], [2852, 1710], [2858, 1704], [2859, 1694], [2851, 1650], [2844, 1641], 
      [2832, 1644], [2825, 1636], [2808, 1637], [2803, 1627], [2794, 1616], [2786, 1613], [2776, 1623], [2770, 1613], [2783, 1590], 
      [2775, 1576], [2741, 1631]
    ]
  },
  {
    name: 'КОУФУ', // Название города (будет крупно в подсказке)
    location: 'Арамидис', // Название региона (будет выделено цветом)
    locationColor: '#8EEB00', // Цвет для названия региона Арамидис (#8EEB00)
    desc: 'Промышленный город в гораз Формауцнтин', // Описание (любой текст)
    forum: 'https://enterum.ru/',
    polygon: [
      [3158, 1817], [3174, 1852], [3191, 1855], [3192, 1890], [3168, 1901], [3161, 1927], [3148, 1934], [3117, 1935], [3092, 1934], 
      [3086, 1927], [3079, 1906], [3075, 1874], [3079, 1845], [3091, 1821], [3098, 1812], [3121, 1822], [3142, 1816], [1983, 1571]
    ]
  },
  {
    name: 'ИГРИДАС', // Название города (будет крупно в подсказке)
    location: 'Арамидис', // Название региона (будет выделено цветом)
    locationColor: '#8EEB00', // Цвет для названия региона Арамидис (#8EEB00)
    desc: 'Город вмещает в своих стенах четыре разных народа: людей, гномов, зверолюдей и эльфов.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/igridas.64/',
    polygon: [
      [1991, 1370], [2024, 1352], [2034, 1355], [2039, 1371], [2048, 1377], [2055, 1390], [2053, 1398], [2059, 1415], [2070, 1432], 
      [2069, 1445], [2092, 1444], [2103, 1455], [2110, 1471], [2098, 1478], [2088, 1481], [2075, 1482], [2070, 1498], [2076, 1499], 
      [2089, 1517], [2076, 1535], [2049, 1537], [2040, 1552], [2035, 1550], [2019, 1562], [2014, 1558], [1996, 1570], [1990, 1567], 
      [1970, 1559], [1949, 1538], [1937, 1516], [1929, 1504], [1924, 1484], [1925, 1446], [1934, 1417], [1963, 1376], [1975, 1367] 
    ]
  },
  {
    name: 'ИРОНХОЛД', // Название города (будет крупно в подсказке)
    location: 'Арамидис', // Название региона (будет выделено цветом)
    locationColor: '#8EEB00', // Цвет для названия региона Арамидис (#8EEB00)
    desc: 'Крепость на востоке от Игридаса.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/ehlgardijskaja-respublika.35/',
    polygon: [
      [2615, 1278], [2627, 1289], [2657, 1300], [2669, 1321], [2673, 1342], [2674, 1354], [2699, 1364], [2672, 1373], [2685, 1376], 
      [2694, 1395], [2681, 1410], [2664, 1410], [2658, 1423], [2628, 1432], [2612, 1456], [2599, 1477], [2569, 1458], [2551, 1437], 
      [2539, 1417], [2532, 1390], [2530, 1363], [2543, 1309], [2564, 1279], [2599, 1255]
    ]
  },
  {
    name: 'КАРТУС', // Название города (будет крупно в подсказке)
    location: 'Арамидис', // Название региона (будет выделено цветом)
    locationColor: '#8EEB00', // Цвет для названия региона Арамидис (#8EEB00)
    desc: 'Небольшой, но оживленный пригород, расположенный на южных подступах к крепости Иронхолд.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/ehlgardijskaja-respublika.35/',
    polygon: [
      [2512, 1541], [2520, 1551], [2537, 1570], [2538, 1583], [2526, 1606], [2513, 1641], [2509, 1643], [2488, 1648], [2475, 1636], 
      [2476, 1557], [2487, 1543]
    ]
  },
  {
    name: 'Идо', // Название города (будет крупно в подсказке)
    location: 'Юнион', // Название региона (будет выделено цветом)
    locationColor: '#73C2FF', // Цвет для названия региона Юнион (#73C2FF)
    desc: 'Высокотехнологичный город, люди в котором вследствие генетических экспериментов были разделены на две подрасы - ренов и скиттов. В южной части города, заселённой скиттами, царит разруха и беззаконие, а в северной, заселённой ренами - процветание и утопия.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/gorod.119/',
    polygon: [
      [2474, 2014], [2444, 2067], [2416, 2153], [2423, 2232], [2480, 2285], [2554, 2285], [2606, 2232], [2637, 2150], [2618, 2072], 
      [2557, 2007], [2523, 1998]
    ]
  },
  {
    name: 'АНДАГРА', // Название города (будет крупно в подсказке)
    location: 'Корзус', // Название региона (будет выделено цветом)
    locationColor: '#FFBA40', // Цвет для названия региона Корзус (#FFBA40)
    desc: 'Крепость на руинах одного из уцелевших городов после аномалии', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/krepost-na-ruinax.37/',
    polygon: [
      [1284, 2119], [1289.5, 2128.5], [1303, 2138.5], [1315, 2137.5], [1334, 2141], [1352.5, 2148.5], [1356.5, 2162], [1366, 2174.5], 
      [1382.5, 2179], [1404, 2179], [1392.5, 2190.5], [1403, 2198], [1413.5, 2199.5], [1407.5, 2206.5], [1415.5, 2213], [1398, 2230], 
      [1413.5, 2243.5], [1404, 2245], [1391, 2240], [1386.5, 2251.5], [1401, 2254.5], [1406.5, 2262], [1401, 2272], [1383.5, 2274], 
      [1365, 2279.5], [1371, 2287.5], [1360, 2292.5], [1357, 2297], [1338.5, 2298.5], [1334.5, 2316], [1317, 2314], [1306.5, 2317.5], 
      [1294.5, 2318.5], [1283, 2329], [1256, 2305], [1244, 2291], [1231.5, 2264.5], [1224.5, 2239.5], [1224.5, 2207.5], [1229, 2184], 
      [1243, 2158], [1264, 2134.5], [1276, 2124]
    ]
  },
  {
    name: 'АЛЬФА-МАЯК', // Название города (будет крупно в подсказке)
    location: 'Корзус', // Название региона (будет выделено цветом)
    locationColor: '#FFBA40', // Цвет для названия региона Корзус (#FFBA40)
    desc: 'Крепость на руинах одного из уцелевших городов после аномалии', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/dolina-nezhiti.39/',
    polygon: [
      [1385, 1082.5], [1332.5, 1079], [1309.5, 1071.5], [1291.5, 1038.5], [1281, 997], [1279.5, 977.5], [1275, 951], [1284, 918.5], 
      [1289.5, 878.5], [1297.5, 850.5], [1307, 803], [1327.5, 789.5], [1337, 772], [1356, 766.5], [1378.5, 788.5], [1389.5, 785],
      [1394.5, 765], [1412, 745.5], [1426.5, 754], [1438, 766], [1468.5, 816.5], [1485, 826], [1491.5, 825.5], [1497, 814.5], [1504, 820], 
      [1523.5, 866.5], [1536.5, 902], [1541, 939.5], [1542, 960], [1526, 972], [1512, 1004.5], [1510.5, 1021.5], [1473, 1020.5], 
      [1453, 1016], [1433.5, 1019.5], [1426, 1036.5], [1418.5, 1062.5], [1410, 1079]
    ]
  },
  {
    name: 'БУНКЕР', // Название города (будет крупно в подсказке)
    location: 'Корзус', // Название региона (будет выделено цветом)
    locationColor: '#FFBA40', // Цвет для названия региона Корзус (#FFBA40)
    desc: 'Один из старых бункеров на юго-востоке Пустошей, который сохранился после бесчисленных конфликтов.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/bunker.42/',
    polygon: [
      [688.5, 2065], [725, 2108.5], [727.5, 2128], [745, 2147.5], [786, 2176.5], [788.5, 2188.5], [814, 2211], [813, 2220], [803.5, 2228], 
      [804.5, 2237.5], [840, 2248], [839.5, 2253], [797.5, 2271], [785.5, 2288.5], [772.5, 2303], [742.5, 2322], [725, 2340.5], 
      [718, 2358.5], [693.5, 2388.5], [637.5, 2323.5], [617.5, 2299.5], [607.5, 2263], [607.5, 2228.5], [619, 2190.5], [641.5, 2159.5], [675, 2118.5]
    ]
  },
  {
    name: 'РЕЙС', // Название города (будет крупно в подсказке)
    location: 'Корзус', // Название региона (будет выделено цветом)
    locationColor: '#FFBA40', // Цвет для названия региона Корзус (#FFBA40)
    desc: 'База банды Лиса.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/gorod-rejs-territorija-lisa.1043/post-33530',
    polygon: [
      [1494, 1947.5], [1570.5, 1960.5], [1575, 1966], [1571.5, 1974.5], [1559, 1979.5], [1572.5, 2003], [1593.5, 2008], [1597.5, 2013.5], 
      [1593, 2021], [1570.5, 2024.5], [1558, 2049], [1569.5, 2054.5], [1574, 2061], [1570, 2067.5], [1494, 2078], [1473, 2079.5], 
      [1441.5, 2069.5], [1432.5, 2059.5], [1426, 2038.5], [1423, 2013], [1424, 1999.5], [1430, 1980], [1442, 1954.5], [1472.5, 1950], [1488, 1945.5]
    ]
  },
  {
    name: 'ЯДОВИТЫЕ ДЖУНГЛИ', // Название города (будет крупно в подсказке)
    location: 'Корзус', // Название региона (будет выделено цветом)
    locationColor: '#FFBA40', // Цвет для названия региона Корзус (#FFBA40)
    desc: 'Несмотря на то, что радиация, стёршая с лица Корзуса всё живое и рукотворное, долгое время господствовала в этих гиблых выжженных пустошах, природа в очередной раз показала, что она способна приспособиться даже к подобной катастрофе.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/jadovitye-dzhungli.78/',
    polygon: [
      [837, 1452], [850.5, 1449], [860, 1437], [905.5, 1409.5], [906, 1386.5], [921, 1361], [955.5, 1340.5], [972, 1351], [985, 1342], 
      [1002.5, 1370], [1018.5, 1370], [1030.5, 1345.5], [1036, 1329], [1049, 1327.5], [1060.5, 1313.5], [1080, 1366.5], [1096.5, 1372.5], 
      [1119.5, 1415.5], [1148, 1430.5], [1166, 1428.5], [1176, 1448.5], [1164.5, 1464.5], [1159.5, 1473.5], [1167, 1485], [1154, 1514], 
      [1167.5, 1535.5], [1156.5, 1559.5], [1165, 1569], [1162, 1583], [1165, 1601], [1153, 1614], [1153, 1635.5], [1132, 1662], [1126.5, 1673.5], 
      [1114, 1698], [1101, 1704.5], [1080.5, 1738], [1078, 1762], [1047.5, 1747.5], [1034, 1731], [1018, 1734], [1010.5, 1750.5], 
      [990.5, 1742.5], [977.5, 1736], [953, 1716.5], [924, 1736.5], [915.5, 1724], [899, 1705.5], [873, 1657], [845, 1667], [822, 1636.5], 
      [834, 1603.5], [830.5, 1574.5], [821, 1565], [835.5, 1547], [839, 1515], [839, 1465], [837, 1450.5]
    ]
  },
  {
    name: 'ГНЕЗДО СКРЯГ', // Название города (будет крупно в подсказке)
    location: 'Корзус', // Название региона (будет выделено цветом)
    locationColor: '#FFBA40', // Цвет для названия региона Корзус (#FFBA40)
    desc: 'Гнездо - нейтральная территория, где можно стоять у одного прилавка плечом к плечу со злейшим врагом, выбирая себе сигары.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/gnezdo.1067/post-36448',
    polygon: [
      [1069.5, 964], [1082, 980], [1085, 994.5], [1105, 1011.5], [1130, 1031.5], [1134.5, 1043], [1153, 1061], [1145.5, 1080.5], 
      [1176, 1089], [1175, 1092.5], [1145.5, 1106.5], [1129, 1127], [1103.5, 1144], [1090.5, 1153.5], [1077.5, 1178], [1068.5, 1182], 
      [1037, 1164], [1012.5, 1139], [998, 1112.5], [994, 1072.5], [1000, 1045], [1014.5, 1021], [1031, 1000.5], [1053, 985], [1075.5, 977.5] 
    ]
  },
  {
    name: 'КПП КОРЗУС-ЮНИОН', // Название города (будет крупно в подсказке)
    location: 'Неизведанные земли', // Название региона (будет выделено цветом)
    locationColor: '#E3E8DC', // Цвет для названия региона Нейтральные земли (#E3E8DC)
    desc: 'КПП связывает два биома - Корзус и Юнион.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/kpp-korzus-junion.1092/post-39905',
    polygon: [
      [1707.5, 2049.5], [1742, 2073], [1732, 2085], [1757, 2102.5], [1741.5, 2126.5], [1729, 2139.5], [1733.5, 2144.5], [1717, 2158.5], 
      [1717, 2172], [1683, 2191.5], [1671, 2195.5], [1628, 2178.5], [1630.5, 2150], [1648.5, 2134], [1702.5, 2049.5]
    ]
  },
  {
    name: 'КПП ЮНИОН-АРАМИДИС', // Название города (будет крупно в подсказке)
    location: 'Неизведанные земли', // Название региона (будет выделено цветом)
    locationColor: '#E3E8DC', // Цвет для названия региона Нейтральные земли (#E3E8DC)
    desc: 'КПП связывает два биома - Юнион и Арамидис.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/kpp-junion-aramidis.1175/post-46521',
    polygon: [
      [2884, 1804.5], [2906.5, 1824.75], [2941, 1873.25], [2932.5, 1890.75], [2959, 1910.75], [2971.25, 1929], [2927, 1978], [2864.5, 1999.5], 
      [2854, 2014.75], [2852.5, 2034], [2848.75, 2051.5], [2828.25, 2103.75], [2805.25, 2110.25], [2796, 2116.75], [2796.25, 2124], [2776.5, 2140.25], 
      [2754.75, 2155.75], [2744, 2166.25], [2731.5, 2166], [2719.25, 2161.5], [2710.5, 2145.75], [2709.75, 2129], [2710.5, 2115.25], 
      [2708.75, 2104.25], [2715.25, 2097.75], [2724.5, 2090], [2732, 2076.75], [2759.25, 2063.25], [2798.25, 2034], [2815.75, 1995.25], 
      [2842.75, 1935.25], [2844.75, 1903], [2847.5, 1890.5], [2832.75, 1870.25]
    ]
  },
  {
    name: 'КПП АРАМИДИС-КОРЗУС', // Название города (будет крупно в подсказке)
    location: 'Неизведанные земли', // Название региона (будет выделено цветом)
    locationColor: '#E3E8DC', // Цвет для названия региона Нейтральные земли (#E3E8DC)
    desc: 'КПП связывает два биома - Арамидис и Корзус.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/kpp-aramidis-korzus-vroklaj-siti.1002/post-29365',
    polygon: [
      [1690.5, 996.5], [1678.5, 1017.5], [1675.75, 1025.5], [1674.75, 1037.5], [1672.75, 1045.25], [1668, 1058.75], [1675.25, 1071], 
      [1690.25, 1075.5], [1708, 1088.5], [1722.75, 1090.25], [1735, 1068.25], [1740, 1042.5], [1751.75, 1020], [1740.25, 997.25]
    ]
  },
  {
    name: 'ДЖИЮ-МУРА', // Название города (будет крупно в подсказке)
    location: 'Независимые поселения Арамидиса', // Название региона (будет выделено цветом)
    locationColor: '#D680FF', // Цвет для названия региона Нейтральные поселения (#D680FF)
    desc: 'Джию-Мура ("Свободная Деревня") — поселение беженцев из Аргадара на берегу Волчьей Реки.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/dzhiju-mura.1108/post-40691',
    polygon: [
      [2361, 1274], [2336, 1284], [2322, 1311], [2322, 1338], [2332, 1363], [2346, 1373], [2371, 1377], [2394, 1364], [2411, 1319], 
      [2391, 1301], [2373, 1300], [2359, 1277]
    ]
  },
  {
    name: 'АР-РУСАЙФА', // Название города (будет крупно в подсказке)
    location: 'Независимые поселения Арамидиса', // Название региона (будет выделено цветом)
    locationColor: '#D680FF', // Цвет для названия региона Нейтральные поселения (#D680FF)
    desc: 'Город на берегу моря, который когда-то славился своими обширными туристическими возможностями.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/dzhiju-mura.1108/post-40691',
    polygon: [
      [3241, 987], [3229, 971], [3216, 950], [3236, 891], [3249, 876], [3257, 872], [3265, 873], [3293, 826], [3298, 826], 
      [3324, 873], [3329, 875], [3330, 882], [3323, 894], [3319, 894], [3310, 881], [3307, 881], [3304, 887], [3300, 888], 
      [3293, 901], [3337, 902], [3344, 908], [3337, 913], [3287, 914], [3287, 918], [3295, 924], [3297, 930], [3295, 937], 
      [3287, 946], [3284, 945], [3283, 948], [3289, 950], [3284, 955], [3279, 956], [3272, 964], [3259, 963], [3256, 968], 
      [3247, 968], [3245, 974], [3289, 977], [3300, 981], [3290, 984], [3259, 987]
    ]
  },
  {
    name: 'ЛИНВАР', // Название города (будет крупно в подсказке)
    location: 'Независимые поселения Арамидиса', // Название региона (будет выделено цветом)
    locationColor: '#D680FF', // Цвет для названия региона Нейтральные поселения (#D680FF)
    desc: 'Деревня является одним из перевалочных пунктов торговцев и простых авантюристов.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/dzhiju-mura.1108/post-40691',
    polygon: [
      [1854, 1005], [1881, 1042], [1886, 1053], [1893, 1062], [1874, 1079], [1867, 1081], [1875, 1089], [1883, 1105],
      [1866, 1113], [1838, 1126], [1828, 1127], [1821, 1126], [1796, 1083], [1793, 1065], [1800, 1032], [1809, 1020], 
      [1820, 1005], [1826, 998]
    ]
  },
];

regions.forEach(region => {
  const shape = L.polygon(region.polygon, { color: 'transparent', weight: 0, fillOpacity: 0.2 });
  shape.addTo(map);
  shape.on('mouseover', function(e) {
    // Кастомная подсказка:
    // 1. Название города (region.name) — крупно
    // 2. Черта
    // 3. Локация (region.location) — цвет задаётся через region.locationColor
    // 4. Описание (region.desc) — просто текст
    const tooltipHtml = `
      <div style="padding:12px 18px; background:#222222; border-radius:5px; box-shadow:0 2px 12px #0002; min-width:230px; border:3px solid #00A6FF;">
        <div style="font-weight:bold; font-size:1.5em; color:#fff; margin-bottom:6px;">${region.name}</div>
        <hr style="margin:6px 0 8px 0; border:none; border-top:1.5px solid #484848;"/>
        <div style="margin-bottom:8px; font-size:1.08em; color:#9d9d9d;">
          <span style="font-weight:bold; color:#9d9d9d;">Регион: </span>
          <span style="color:${region.locationColor || '#3388ff'}; font-weight:bold;">${region.location || '—'}</span>
        </div>
        <div style="font-size:1em; color:#9d9d9d; white-space:pre-line;">${region.desc || ''}</div>
      </div>
    `;
    this.setStyle({ color: 'orange', fillOpacity: 0.4 });
    this.bindTooltip(tooltipHtml, {sticky: true, direction: 'top', className: 'custom-tooltip'}).openTooltip();
  });
  shape.on('mouseout', function(e) {
    this.setStyle({ color: 'transparent', fillOpacity: 0.2 });
    this.closeTooltip();
  });
  shape.on('click', function() {
    window.open(region.forum, '_blank');
  });
});

map.on('click', function(e) {
  // Для CRS.Simple координаты e.latlng соответствуют [y, x]
  console.log('Координаты клика:', e.latlng);
});
