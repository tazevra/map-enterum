// main.js — логика главной карты
// Используем изображение карты мира как подложку
const imageUrl = 'IMG/world.webp'; // Путь к изображению карты мира
const imageBounds = [[0,0], [4096,5316]]; // Карта мира: 4096x4096
// Используем CRS.Simple для точного отображения изображения
const map = L.map('map', {
  crs: L.CRS.Simple,
  minZoom: -2,
  maxZoom: 2, // Максимальное приближение в 2 раза
  maxBounds: imageBounds, // Ограничение перемещения ровно по картинке
  maxBoundsViscosity: 1.0 // Жёсткое ограничение
});
L.imageOverlay(imageUrl, imageBounds).addTo(map);
// Масштабирование по ширине 4096px
const mapWidth = 4096;
const windowWidth = window.innerWidth;
const zoomToFitWidth = Math.log2(windowWidth / mapWidth);
map.setView([imageBounds[1][0] / 2, mapWidth / 2], zoomToFitWidth);

// Новые регионы с координатами под изображение
const regions = [
  {
    name: 'Йошихара', // Название города (будет крупно в подсказке)
    location: 'Арамидис', // Название региона (будет выделено цветом)
    locationColor: '#8EEB00', // Цвет для названия региона Арамидис (#8EEB00)
    desc: 'Йошихара, или как его называют местные люди - “Город розовых слёз”. Город торговли, фестивалей и магии.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/joshixara.124/',
    polygon: [
      [3076, 1184], [3063, 1167], [3036, 1154], [3018, 1162], [3013, 1193], [2999, 1210], [2987, 1235], [2976, 1260], [2956, 1258],
      [2941, 1278], [2934, 1301], [2932, 1332], [2943, 1351], [2969, 1358], [2986, 1381], [3005, 1407], [3029, 1425], [3052, 1430],
      [3056, 1407], [3069, 1405], [3082, 1396], [3098, 1381], [3113, 1364], [3130, 1369], [3153, 1382], [3178, 1381], [3197, 1362],
      [3203, 1339], [3184, 1322], [3168, 1315], [3160, 1304], [3163, 1282], [3141, 1280], [3132, 1269], [3119, 1265], [3116, 1252],
      [3105, 1242], [3087, 1234], [3070, 1226], [3068, 1210], [3071, 1197], [3078, 1185]
    ]
  },
  {
    name: 'Игридас', // Название города (будет крупно в подсказке)
    location: 'Арамидис', // Название региона (будет выделено цветом)
    locationColor: '#8EEB00', // Цвет для названия региона Арамидис (#8EEB00)
    desc: 'Игридас - город, созданный некогда могущественной чародейкой Игрид. Вмещает в своих стенах четыре разных народа: людей, гномов, зверолюдей и эльфов. Они, живущие каждый в своем районе, долгое время почти не контактируют друг с другом, а объединяет их на данный момент лишь Академия Портмэрион, являющаяся нейтральной территорией.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/igridas.64/',
    polygon: [
      [2756, 845], [2804, 867], [2849, 890], [2891, 909], [2908, 946], [2896, 987], [2810, 1081], [2761, 1091], [2720, 921], [2735, 871]
    ]
  },
  {
    name: 'Идо', // Название города (будет крупно в подсказке)
    location: 'Юнион', // Название региона (будет выделено цветом)
    locationColor: '#73C2FF', // Цвет для названия региона Юнион (#73C2FF)
    desc: 'Высокотехнологичный город, люди в котором вследствие генетических экспериментов были разделены на две подрасы - ренов и скиттов. В южной части города, заселённой скиттами, царит разруха и беззаконие, а в северной, заселённой ренами - процветание и утопия.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/gorod.119/',
    polygon: [
      [2474, 2014], [2444, 2067], [2416, 2153], [2423, 2232], [2480, 2285], [2554, 2285], [2606, 2232], [2637, 2150], [2618, 2072], 
      [2557, 2007], [2523, 1998]
    ]
  },
  {
    name: 'Бункер', // Название города (будет крупно в подсказке)
    location: 'Корзус', // Название региона (будет выделено цветом)
    locationColor: '#FFBA40', // Цвет для названия региона Корзус (#FFBA40)
    desc: 'Один из старых бункеров на юго-востоке Пустошей, который сохранился после бесчисленных конфликтов. Глубокое строение, чей вход замаскирован скалистой местностью и обладающее наработками старых обитателей Корзуса – это все стало отличным подспорьем для того, чтобы обитатели Бункера сделали его основным фортификационным сооружением.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?forums/bunker.42/',
    polygon: [
      [1568, 1971], [1621, 1934], [1663, 1890], [1673, 1797], [1602, 1729], [1564, 1693], [1524, 1680], [1450, 1691], 
      [1418, 1793], [1421, 1905], [1440, 1999], [1477, 2020]
    ]
  },
  {
    name: 'КПП Корзус-Юнион', // Название города (будет крупно в подсказке)
    location: 'Неизведанные земли', // Название региона (будет выделено цветом)
    locationColor: '#E3E8DC', // Цвет для названия региона Нейтральные земли (#E3E8DC)
    desc: 'Западный город, окружённый горами и лесами.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/kpp-junion-aramidis.1175/unread',
    polygon: [
      [2360, 1730], [2450, 1830], [2114, 2198], [2006, 2110]
    ]
  },
    {
    name: 'Джию-Мура', // Название города (будет крупно в подсказке)
    location: 'Независимые поселения Арамидиса', // Название региона (будет выделено цветом)
    locationColor: '#D680FF', // Цвет для названия региона Нейтральные поселения (#D680FF)
    desc: 'Джию-Мура ("Свободная Деревня") — поселение беженцев из Аргадара на берегу Волчьей Реки. Богатые земли и удачное расположение на торговом пути Иронхолд–Игридас сделали её процветающим купеческим узлом. После конфликта с баронами деревня отстояла независимость под защитой Драконьего Порядка. Теперь это вольное поселение с бурной историей и большими возможностями.', // Описание (любой текст)
    forum: 'https://enterum.ru/index.php?threads/dzhiju-mura.1108/post-40691',
    polygon: [
      [2946, 965], [2958, 992], [2954, 1028], [2943, 1056], [2920, 1073], [2903, 1062], [2896, 1026], [2894, 991], 
      [2909, 954], [2924, 936]
    ]
  },
];

regions.forEach(region => {
  const shape = L.polygon(region.polygon, { color: 'transparent', weight: 0, fillOpacity: 0.2 });
  shape.addTo(map);
  shape.on('mouseover', function(e) {
    // Кастомная подсказка:
    // 1. Название города (region.name) — крупно
    // 2. Черта
    // 3. Локация (region.location) — цвет задаётся через region.locationColor
    // 4. Описание (region.desc) — просто текст
    const tooltipHtml = `
      <div style="padding:12px 18px; background:#222222; border-radius:5px; box-shadow:0 2px 12px #0002; min-width:230px; border:3px solid #00A6FF;">
        <div style="font-weight:bold; font-size:1.5em; color:#fff; margin-bottom:6px;">${region.name}</div>
        <hr style="margin:6px 0 8px 0; border:none; border-top:1.5px solid #484848;"/>
        <div style="margin-bottom:8px; font-size:1.08em; color:#9d9d9d;">
          <span style="font-weight:bold; color:#9d9d9d;">Регион: </span>
          <span style="color:${region.locationColor || '#3388ff'}; font-weight:bold;">${region.location || '—'}</span>
        </div>
        <div style="font-size:1em; color:#9d9d9d; white-space:pre-line;">${region.desc || ''}</div>
      </div>
    `;
    this.setStyle({ color: 'orange', fillOpacity: 0.4 });
    this.bindTooltip(tooltipHtml, {sticky: true, direction: 'top', className: 'custom-tooltip'}).openTooltip();
  });
  shape.on('mouseout', function(e) {
    this.setStyle({ color: 'transparent', fillOpacity: 0.2 });
    this.closeTooltip();
  });
  shape.on('click', function() {
    window.open(region.forum, '_blank');
  });
});

map.on('click', function(e) {
  // Для CRS.Simple координаты e.latlng соответствуют [y, x]
  console.log('Координаты клика:', e.latlng);
});
